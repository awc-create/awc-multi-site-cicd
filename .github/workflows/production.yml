name: Vercel Production Deployment

on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  VERCEL_ORG_ID: ${{ secrets[format('{0}_VERCEL_ORG_ID', github.event.workflow_run.head_repository.name)] }}
  VERCEL_PROJECT_ID: ${{ secrets[format('{0}_VERCEL_PROJECT_ID', github.event.workflow_run.head_repository.name)] }}

jobs:
  deploy-production:
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: main
          path: site-repo

      - name: Debug - Confirm Checkout Worked
        run: |
          echo "Step: Confirming repository checkout"
          echo "Current Directory: $(pwd)"
          echo "Checking if site-repo exists:"
          ls -la || echo "⚠️ No site-repo directory found!"
          echo "Checking site-repo contents:"
          ls -la site-repo || echo "⚠️ site-repo is empty!"

      - name: Debug - Verify Repository Structure
        run: |
          echo "Step: Checking repository structure"
          echo "Listing contents of site-repo:"
          ls -la site-repo
          echo "Checking inside src/app/:"
          ls -la site-repo/src/app || echo "⚠️ No app/ directory found in src/"
          ls -la site-repo/src/app/page.tsx || echo "⚠️ page.tsx not found!"
        working-directory: site-repo

      - name: Install Dependencies
        run: |
          echo "Step: Installing Dependencies"
          if [ ! -d "site-repo" ]; then
            echo "⚠️ Error: site-repo directory not found! Exiting..."
            exit 1
          fi
          npm install
        working-directory: site-repo

      - name: Build Next.js First
        run: |
          echo "Step: Building Next.js"
          if [ ! -d "site-repo" ]; then
            echo "⚠️ Error: site-repo directory not found! Exiting..."
            exit 1
          fi
          npm run build
        working-directory: site-repo

      - name: Install Vercel CLI
        run: |
          echo "Step: Installing Vercel CLI"
          npm install -g vercel
        working-directory: site-repo

      - name: Pull Vercel Production Environment
        run: |
          echo "Step: Pulling Vercel Production Environment"
          vercel pull --yes \
            --environment=production \
            --token=${{ env.VERCEL_TOKEN }} \
            --scope=${{ env.VERCEL_ORG_ID }}
        working-directory: site-repo

      - name: Deploy Production to Vercel (Only If Build Succeeded)
        run: |
          echo "Step: Deploying Production to Vercel"
          vercel deploy --prebuilt --prod --token=${{ env.VERCEL_TOKEN }}
        working-directory: site-repo
